
## String 类型内存消耗问题

String 类型：一个键对应一个值的数据（“键 - 单值”）

String 类型可以保存二进制字节流，就像“万金油”一样，只要把数据转成二进制字节数组，就可以保存了。（可以把对象序列成 byte 数组保存）

> 场景 1: 存储图片对应关系(图片 id -- 图片 oss id)

```
id: 1101000051
oss_id: 3301000051
```

> 当图片越来越大，达到 10 亿数量时，大约用 6.4G 内存

<p style='color:red'>String 类型并不是适用于所有场合的，它有一个明显的短板，就是它保存数据时所消耗的内存空间较多。</p>
集合类型有非常节省内存空间的底层实现结构，但是，集合类型保存的数据模式，是一个键对应一系列值，并不适合直接保存单值的键值对。

使用二级编码的方法，实现了用集合类型保存单值键值对，Redis 实例的内存空间消耗会明显下降

### 为什么 String 类型内存开销大

结合刚才案例，1 亿图片信息使用了约 6.4G 内存，即一个图片 ID 和图片存储对象 ID 的记录平均用了 64 字节。但问题是，实际只需要 16 字节就可以了。

图片 ID 和图片存储对象 ID 都是 10 位数，我们可以用两个 8 字节的 Long 类型表示这两个 ID，因为 8 字节的 Long 类型最大可以表示 2 的 64 次方的数值，可以表示 10 位数

除了记录实际数据，String 类型还需要额外内存空间记录数据长度、空间使用等信息，这些信息称为`元数据`。

**String 类型保存数据方式：**

1. 当保存 64 位有符号整数时，String 类型会把它保存为一个 8 字节的 Long 类型整数，这种保存方式通常也叫作 `int 编码方式`。
2. 当保存的数据中包含字符时，String 类型就会用简单动态字符串（Simple Dynamic String，SDS）结构体来保存

_String 中保存整数会用 int 编码方式，而保存的是字符时会用 SDS(简单动态字符串)结构来保存_

**SDS 保存数据方式**

| 方式  | 大小   | 说明                                                                     |
| ----- | ------ | ------------------------------------------------------------------------ |
| buf   | 8 字节 | 字节数组，保持实际数据。Redis 会自动在数组最后加'\0',会额外占用 1 个字节 |
| len   | 4 字节 | 表示 buf 的已有长度                                                      |
| alloc | 4 字节 | 表示 buf 的实际分配长度，一遍大于 len                                    |

除了 SDS 中的`len`和`alloc`的额外开销（相对于数据本身），还有来自`RedisObject`结构体的开销。

## 选择节省内存开销的数据类型
